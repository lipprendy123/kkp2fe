<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PO System - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @media print {
        body * {
          visibility: hidden;
        }

        /* Nota */
        #notaPreviewContent,
        #notaPreviewContent * {
          visibility: visible;
        }
        #notaPreviewContent {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }

        /* SO */
        #soPreviewContent,
        #soPreviewContent * {
          visibility: visible;
        }
        #soPreviewContent {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }

        /* Surat Jalan */
        #suratJalanPreviewContent,
        #suratJalanPreviewContent * {
          visibility: visible;
        }
        #suratJalanPreviewContent {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }

        /* Kwitansi */
        #kwitansiPreviewContent,
        #kwitansiPreviewContent * {
          visibility: visible;
        }
        #kwitansiPreviewContent {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }

        /* Sembunyikan header modal */
        #previewNotaModal > div > div:first-child,
        #previewSOModal > div > div:first-child,
        #previewSuratJalanModal > div > div:first-child,
        #previewKwitansiModal > div > div:first-child {
          display: none;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center">
      <div class="bg-white p-8 rounded-lg shadow-lg w-96">
        <h2 class="text-2xl font-bold mb-6 text-center">Login Admin</h2>
        <form id="loginForm">
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Username</label>
            <input
              type="text"
              id="loginUsername"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div class="mb-6">
            <label class="block text-gray-700 mb-2">Password</label>
            <input
              type="password"
              id="loginPassword"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <button
            type="submit"
            class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
          >
            Login
          </button>
        </form>
        <div id="loginError" class="mt-4 text-red-500 text-sm hidden"></div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="hidden">
      <!-- Navbar -->
      <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
          <h1 class="text-xl font-bold">PO System</h1>
          <div class="flex items-center gap-4">
            <span id="adminName"></span>
            <button
              onclick="logout()"
              class="bg-red-500 px-4 py-2 rounded hover:bg-red-600"
            >
              Logout
            </button>
          </div>
        </div>
      </nav>

      <!-- Sidebar & Content -->
      <div class="flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white h-screen shadow-lg">
          <div class="p-4">
            <button
              onclick="showPage('dashboard')"
              class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded mb-2"
            >
              <i class="fas fa-dashboard mr-2"></i> Dashboard
            </button>
            <button
              onclick="showPage('pelanggan')"
              class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded mb-2"
            >
              <i class="fas fa-users mr-2"></i> Data Pelanggan
            </button>
            <button
              onclick="showPage('barang')"
              class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded mb-2"
            >
              <i class="fas fa-box mr-2"></i> Data Barang
            </button>
            <button
              onclick="showPage('po')"
              class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded mb-2"
            >
              <i class="fas fa-file-invoice mr-2"></i> Purchase Order
            </button>
            <button
              onclick="showPage('so')"
              class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded mb-2"
            >
              <i class="fas fa-shopping-cart mr-2"></i> Sales Order
            </button>
            <button
              onclick="showPage('nota')"
              class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded mb-2"
            >
              <i class="fas fa-receipt mr-2"></i> Nota
            </button>
            <button
              onclick="showPage('laporan')"
              class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded mb-2"
            >
              <i class="fas fa-chart-bar mr-2"></i> Laporan
            </button>
            <button
              onclick="showPage('suratjalan')"
              class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded mb-2"
            >
              <i class="fas fa-truck mr-2"></i> Surat Jalan
            </button>
            <button
              onclick="showPage('kwitansi')"
              class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded mb-2"
            >
              <i class="fas fa-money-bill mr-2"></i> Kwitansi
            </button>
          </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6">
          <!-- Dashboard Stats -->
          <div id="dashboardContent" class="page-content">
            <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-gray-500 text-sm">Penjualan Hari Ini</div>
                <div class="text-2xl font-bold" id="statPenjualanHariIni">
                  Rp 0
                </div>
              </div>
              <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-gray-500 text-sm">Transaksi Hari Ini</div>
                <div class="text-2xl font-bold" id="statTransaksiHariIni">
                  0
                </div>
              </div>
              <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-gray-500 text-sm">Total Pelanggan</div>
                <div class="text-2xl font-bold" id="statTotalPelanggan">0</div>
              </div>
              <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-gray-500 text-sm">Total Barang</div>
                <div class="text-2xl font-bold" id="statTotalBarang">0</div>
              </div>
            </div>
          </div>

          <!-- Pelanggan Page -->
          <div id="pelangganContent" class="page-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">Data Pelanggan</h2>
              <button
                onclick="showAddPelangganModal()"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                <i class="fas fa-plus mr-2"></i> Tambah Pelanggan
              </button>
            </div>
            <div class="bg-white rounded-lg shadow">
              <div class="p-4">
                <input
                  type="text"
                  id="searchPelanggan"
                  placeholder="Cari pelanggan..."
                  class="w-full px-3 py-2 border rounded-lg"
                  onkeyup="loadPelanggan()"
                />
              </div>
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left">No Pelanggan</th>
                    <th class="px-6 py-3 text-left">Nama</th>
                    <th class="px-6 py-3 text-left">Alamat</th>
                    <th class="px-6 py-3 text-left">Telp</th>
                    <th class="px-6 py-3 text-left">Aksi</th>
                  </tr>
                </thead>
                <tbody id="pelangganTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Barang Page -->
          <div id="barangContent" class="page-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">Data Barang</h2>
              <div class="flex gap-2">
                <button
                  onclick="showKategoriModal()"
                  class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                >
                  <i class="fas fa-tags mr-2"></i> Kelola Kategori
                </button>
                <button
                  onclick="showAddBarangModal()"
                  class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                >
                  <i class="fas fa-plus mr-2"></i> Tambah Barang
                </button>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow">
              <div class="p-4">
                <input
                  type="text"
                  id="searchBarang"
                  placeholder="Cari barang..."
                  class="w-full px-3 py-2 border rounded-lg"
                  onkeyup="loadBarang()"
                />
              </div>
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left">Kode</th>
                    <th class="px-6 py-3 text-left">Nama</th>
                    <th class="px-6 py-3 text-left">Kategori</th>
                    <th class="px-6 py-3 text-left">Harga</th>
                    <th class="px-6 py-3 text-left">Stok</th>
                    <th class="px-6 py-3 text-left">Aksi</th>
                  </tr>
                </thead>
                <tbody id="barangTable"></tbody>
              </table>
            </div>
          </div>

          <!-- PO Page -->
          <div id="poContent" class="page-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">Purchase Order</h2>
              <button
                onclick="showAddPOModal()"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                <i class="fas fa-plus mr-2"></i> Buat PO
              </button>
            </div>
            <div class="bg-white rounded-lg shadow">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left">No PO</th>
                    <th class="px-6 py-3 text-left">Tanggal</th>
                    <th class="px-6 py-3 text-left">Pelanggan</th>
                    <th class="px-6 py-3 text-left">Total</th>
                    <th class="px-6 py-3 text-left">Status</th>
                    <th class="px-6 py-3 text-left">Aksi</th>
                  </tr>
                </thead>
                <tbody id="poTable"></tbody>
              </table>
            </div>
          </div>

          <!-- SO Page -->
          <div id="soContent" class="page-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">Sales Order</h2>
              <button
                onclick="showAddSOModal()"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                <i class="fas fa-plus mr-2"></i> Buat SO
              </button>
            </div>
            <div class="bg-white rounded-lg shadow">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left">No SO</th>
                    <th class="px-6 py-3 text-left">Tanggal</th>
                    <th class="px-6 py-3 text-left">No PO</th>
                    <th class="px-6 py-3 text-left">Pelanggan</th>
                    <th class="px-6 py-3 text-left">Status</th>
                    <th class="px-6 py-3 text-left">Aksi</th>
                  </tr>
                </thead>
                <tbody id="soTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Nota Page -->
          <div id="notaContent" class="page-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">Nota</h2>
              <button
                onclick="showAddNotaModal()"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                <i class="fas fa-plus mr-2"></i> Buat Nota
              </button>
            </div>
            <div class="bg-white rounded-lg shadow">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left">No Nota</th>
                    <th class="px-6 py-3 text-left">Tanggal</th>
                    <th class="px-6 py-3 text-left">Pelanggan</th>
                    <th class="px-6 py-3 text-left">Total</th>
                    <th class="px-6 py-3 text-left">Sisa Bayar</th>
                    <th class="px-6 py-3 text-left">Aksi</th>
                  </tr>
                </thead>
                <tbody id="notaTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Laporan Page -->
          <div id="laporanContent" class="page-content hidden">
            <h2 class="text-2xl font-bold mb-6">Laporan</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-bold mb-4">Laporan Penjualan</h3>
                <button
                  onclick="downloadLaporanPenjualan()"
                  class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full"
                >
                  <i class="fas fa-download mr-2"></i> Download Laporan
                </button>
              </div>
              <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-bold mb-4">Barang Terlaris</h3>
                <div id="barangTerlarisTable"></div>
              </div>
              <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-bold mb-4">Pelanggan Royal</h3>
                <div id="pelangganRoyalTable"></div>
              </div>
            </div>
          </div>

          <!-- Surat Jalan Page -->
          <div id="suratjalanContent" class="page-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">Surat Jalan</h2>
              <button
                onclick="showAddSuratJalanModal()"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                <i class="fas fa-plus mr-2"></i> Buat Surat Jalan
              </button>
            </div>
            <div class="bg-white rounded-lg shadow">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left">No SJ</th>
                    <th class="px-6 py-3 text-left">Tanggal</th>
                    <th class="px-6 py-3 text-left">No SO</th>
                    <th class="px-6 py-3 text-left">Pelanggan</th>
                    <th class="px-6 py-3 text-left">Alamat Kirim</th>
                    <th class="px-6 py-3 text-left">Aksi</th>
                  </tr>
                </thead>
                <tbody id="suratJalanTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Kwitansi Page -->
          <div id="kwitansiContent" class="page-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">Kwitansi</h2>
              <button
                onclick="showAddKwitansiModal()"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
              >
                <i class="fas fa-plus mr-2"></i> Buat Kwitansi
              </button>
            </div>
            <div class="bg-white rounded-lg shadow">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left">No Kwitansi</th>
                    <th class="px-6 py-3 text-left">Tanggal</th>
                    <th class="px-6 py-3 text-left">No Nota</th>
                    <th class="px-6 py-3 text-left">Pelanggan</th>
                    <th class="px-6 py-3 text-left">Jumlah Bayar</th>
                    <th class="px-6 py-3 text-left">Metode</th>
                    <th class="px-6 py-3 text-left">Aksi</th>
                  </tr>
                </thead>
                <tbody id="kwitansiTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Add Pelanggan -->
    <div
      id="addPelangganModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-xl font-bold mb-4">Tambah Pelanggan</h3>
        <form id="addPelangganForm">
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Nama</label>
            <input
              type="text"
              id="nmplg"
              class="w-full px-3 py-2 border rounded-lg"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Alamat</label>
            <textarea
              id="alamat"
              class="w-full px-3 py-2 border rounded-lg"
              required
            ></textarea>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Telepon</label>
            <input
              type="text"
              id="telp"
              class="w-full px-3 py-2 border rounded-lg"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Email</label>
            <input
              type="email"
              id="email"
              class="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
            >
              Simpan
            </button>
            <button
              type="button"
              onclick="closeModal('addPelangganModal')"
              class="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400"
            >
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Add Barang -->
    <div
      id="addBarangModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div class="bg-white p-6 rounded-lg w-96">
        <h3 class="text-xl font-bold mb-4">Tambah Barang</h3>
        <form id="addBarangForm">
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Nama Barang</label>
            <input
              type="text"
              id="nmbrg"
              class="w-full px-3 py-2 border rounded-lg"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Kategori</label>
            <select
              id="kategoriSelect"
              class="w-full px-3 py-2 border rounded-lg"
              required
            ></select>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Harga</label>
            <input
              type="number"
              id="harga"
              class="w-full px-3 py-2 border rounded-lg"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Stok</label>
            <input
              type="number"
              id="stok"
              class="w-full px-3 py-2 border rounded-lg"
              required
            />
          </div>
          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
            >
              Simpan
            </button>
            <button
              type="button"
              onclick="closeModal('addBarangModal')"
              class="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400"
            >
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Kategori -->
    <div
      id="kategoriModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
      style="display: none"
    >
      <div class="bg-white p-6 rounded-lg w-96">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Kelola Kategori</h3>
          <button
            onclick="closeModal('kategoriModal')"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Form Tambah Kategori -->
        <form id="addKategoriForm" class="mb-4">
          <div class="mb-3">
            <label class="block text-gray-700 mb-2">Nama Kategori</label>
            <input
              type="text"
              id="nmkategori"
              class="w-full px-3 py-2 border rounded-lg"
              required
            />
          </div>
          <div class="mb-3">
            <label class="block text-gray-700 mb-2">Deskripsi</label>
            <textarea
              id="deskripsi"
              class="w-full px-3 py-2 border rounded-lg"
            ></textarea>
          </div>
          <button
            type="submit"
            class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
          >
            <i class="fas fa-plus mr-2"></i> Tambah Kategori
          </button>
        </form>

        <hr class="my-4" />

        <!-- List Kategori -->
        <div>
          <h4 class="font-bold mb-2">Daftar Kategori</h4>
          <div id="kategoriList" class="max-h-64 overflow-y-auto"></div>
        </div>
      </div>
    </div>

    <!-- Modal Buat PO -->
    <div
      id="addPOModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
      style="display: none"
    >
      <div
        class="bg-white p-6 rounded-lg w-[600px] max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Buat Purchase Order</h3>
          <button
            onclick="closeModal('addPOModal')"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="addPOForm">
          <!-- Pilih Pelanggan -->
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Pelanggan</label>
            <select
              id="poPelangganSelect"
              class="w-full px-3 py-2 border rounded-lg"
              required
            >
              <option value="">Pilih Pelanggan</option>
            </select>
          </div>

          <!-- Items -->
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Barang yang Dipesan</label>
            <div id="poItemsContainer">
              <div class="po-item flex gap-2 mb-2">
                <select
                  class="flex-1 px-3 py-2 border rounded-lg po-barang-select"
                  required
                >
                  <option value="">Pilih Barang</option>
                </select>
                <input
                  type="number"
                  placeholder="Qty"
                  class="w-24 px-3 py-2 border rounded-lg po-qty"
                  min="1"
                  required
                />
                <button
                  type="button"
                  onclick="removePOItem(this)"
                  class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <button
              type="button"
              onclick="addPOItem()"
              class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm"
            >
              <i class="fas fa-plus mr-1"></i> Tambah Barang
            </button>
          </div>

          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
            >
              Buat PO
            </button>
            <button
              type="button"
              onclick="closeModal('addPOModal')"
              class="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400"
            >
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Buat SO -->
    <div
      id="addSOModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
      style="display: none"
    >
      <div
        class="bg-white p-6 rounded-lg w-[600px] max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Buat Sales Order</h3>
          <button
            onclick="closeModal('addSOModal')"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="addSOForm">
          <!-- Pilih PO -->
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Purchase Order</label>
            <select
              id="soPOSelect"
              class="w-full px-3 py-2 border rounded-lg"
              required
              onchange="loadPODetails()"
            >
              <option value="">Pilih PO</option>
            </select>
          </div>

          <!-- Detail PO -->
          <div id="poDetailsContainer" class="mb-4 hidden">
            <div class="bg-gray-50 p-3 rounded">
              <p class="text-sm">
                <strong>Pelanggan:</strong> <span id="poDetailPelanggan"></span>
              </p>
              <p class="text-sm">
                <strong>Total:</strong> <span id="poDetailTotal"></span>
              </p>
            </div>
          </div>

          <!-- Items -->
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Barang yang Dikirim</label>
            <div id="soItemsContainer"></div>
          </div>

          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
            >
              Buat SO
            </button>
            <button
              type="button"
              onclick="closeModal('addSOModal')"
              class="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400"
            >
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Buat Surat Jalan -->
    <div
      id="addSuratJalanModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
      style="display: none"
    >
      <div class="bg-white p-6 rounded-lg w-[500px]">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Buat Surat Jalan</h3>
          <button
            onclick="closeModal('addSuratJalanModal')"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="addSuratJalanForm">
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Sales Order</label>
            <select
              id="sjSOSelect"
              class="w-full px-3 py-2 border rounded-lg"
              required
              onchange="loadSOForSJ()"
            >
              <option value="">Pilih SO</option>
            </select>
          </div>

          <div id="sjSODetail" class="mb-4 hidden bg-gray-50 p-3 rounded">
            <p class="text-sm">
              <strong>Pelanggan:</strong> <span id="sjPelanggan"></span>
            </p>
            <p class="text-sm">
              <strong>Alamat:</strong> <span id="sjAlamatDefault"></span>
            </p>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Alamat Pengiriman</label>
            <textarea
              id="sjAlamat"
              class="w-full px-3 py-2 border rounded-lg"
              rows="3"
              required
              placeholder="Masukkan alamat pengiriman"
            ></textarea>
          </div>

          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
            >
              <i class="fas fa-truck mr-2"></i> Buat Surat Jalan
            </button>
            <button
              type="button"
              onclick="closeModal('addSuratJalanModal')"
              class="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400"
            >
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Buat Kwitansi -->
    <div
      id="addKwitansiModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
      style="display: none"
    >
      <div class="bg-white p-6 rounded-lg w-[500px]">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Buat Kwitansi</h3>
          <button
            onclick="closeModal('addKwitansiModal')"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="addKwitansiForm">
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Nota</label>
            <select
              id="kwitansiNotaSelect"
              class="w-full px-3 py-2 border rounded-lg"
              required
              onchange="loadNotaForKwitansi()"
            >
              <option value="">Pilih Nota</option>
            </select>
          </div>

          <div
            id="kwitansiNotaDetail"
            class="mb-4 hidden bg-gray-50 p-3 rounded"
          >
            <p class="text-sm">
              <strong>Pelanggan:</strong> <span id="kwitansiPelanggan"></span>
            </p>
            <p class="text-sm">
              <strong>Total:</strong> <span id="kwitansiTotal"></span>
            </p>
            <p class="text-sm">
              <strong>Sudah Dibayar:</strong> <span id="kwitansiDP"></span>
            </p>
            <p class="text-sm font-bold text-red-600">
              <strong>Sisa Bayar:</strong> <span id="kwitansiSisa"></span>
            </p>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Jumlah Bayar</label>
            <input
              type="number"
              id="kwitansiJumlah"
              class="w-full px-3 py-2 border rounded-lg"
              min="1"
              required
              placeholder="Masukkan jumlah pembayaran"
            />
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Metode Pembayaran</label>
            <select
              id="kwitansiMetode"
              class="w-full px-3 py-2 border rounded-lg"
              required
            >
              <option value="cash">Cash</option>
              <option value="transfer">Transfer</option>
              <option value="giro">Giro</option>
            </select>
          </div>

          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
            >
              <i class="fas fa-receipt mr-2"></i> Buat Kwitansi
            </button>
            <button
              type="button"
              onclick="closeModal('addKwitansiModal')"
              class="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400"
            >
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Preview Nota -->
    <div
      id="previewNotaModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
      style="display: none"
    >
      <div class="bg-white rounded-lg w-[800px] max-h-[90vh] overflow-y-auto">
        <div
          class="sticky top-0 bg-white border-b p-4 flex justify-between items-center"
        >
          <h3 class="text-xl font-bold">Preview Nota</h3>
          <div class="flex gap-2">
            <button
              onclick="window.print()"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              <i class="fas fa-print mr-2"></i> Print Preview
            </button>
            <button
              onclick="closeModal('previewNotaModal')"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Nota Template -->
        <div id="notaPreviewContent" class="p-8">
          <!-- Header Perusahaan -->
          <div class="text-center border-b-2 border-black pb-4 mb-6">
            <h1 class="text-3xl font-bold">CV. Inovazi Mandiri</h1>
            <p class="text-sm">
              Jl. Beringin III No.84, RT.03/RW.07 Pamulang Bar., Kec. Pamulang,
              Kota Tangerang Selatan, Banten 15417
            </p>
            <p class="text-sm">
              Telp: (021) 12345678 | Email: info@perusahaan.com
            </p>
          </div>

          <!-- Judul Nota -->
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold">NOTA PENJUALAN</h2>
          </div>

          <!-- Info Nota & Pelanggan -->
          <div class="grid grid-cols-2 gap-8 mb-6">
            <div>
              <table class="w-full text-sm">
                <tr>
                  <td class="py-1 font-semibold w-32">No. Nota</td>
                  <td class="py-1">: <span id="prevNotaNo"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">Tanggal</td>
                  <td class="py-1">: <span id="prevNotaTgl"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">No. SO</td>
                  <td class="py-1">: <span id="prevNotaSO"></span></td>
                </tr>
              </table>
            </div>
            <div>
              <table class="w-full text-sm">
                <tr>
                  <td class="py-1 font-semibold w-32">Kepada Yth</td>
                  <td class="py-1">: <span id="prevNotaPelanggan"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">Alamat</td>
                  <td class="py-1">: <span id="prevNotaAlamat"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">Telp</td>
                  <td class="py-1">: <span id="prevNotaTelp"></span></td>
                </tr>
              </table>
            </div>
          </div>

          <!-- Tabel Barang -->
          <table class="w-full border-collapse border border-gray-300 mb-6">
            <thead class="bg-gray-100">
              <tr>
                <th class="border border-gray-300 px-4 py-2 text-left">No</th>
                <th class="border border-gray-300 px-4 py-2 text-left">
                  Nama Barang
                </th>
                <th class="border border-gray-300 px-4 py-2 text-center">
                  Qty
                </th>
                <th class="border border-gray-300 px-4 py-2 text-right">
                  Harga Satuan
                </th>
                <th class="border border-gray-300 px-4 py-2 text-right">
                  Subtotal
                </th>
              </tr>
            </thead>
            <tbody id="prevNotaItems"></tbody>
            <tfoot>
              <tr class="bg-gray-50 font-bold">
                <td
                  colspan="4"
                  class="border border-gray-300 px-4 py-2 text-right"
                >
                  TOTAL
                </td>
                <td
                  class="border border-gray-300 px-4 py-2 text-right"
                  id="prevNotaTotal"
                ></td>
              </tr>
              <tr>
                <td
                  colspan="4"
                  class="border border-gray-300 px-4 py-2 text-right"
                >
                  DP / Uang Muka
                </td>
                <td
                  class="border border-gray-300 px-4 py-2 text-right"
                  id="prevNotaDP"
                ></td>
              </tr>
              <tr class="bg-yellow-50 font-bold text-lg">
                <td
                  colspan="4"
                  class="border border-gray-300 px-4 py-2 text-right"
                >
                  SISA BAYAR
                </td>
                <td
                  class="border border-gray-300 px-4 py-2 text-right text-red-600"
                  id="prevNotaSisa"
                ></td>
              </tr>
            </tfoot>
          </table>

          <!-- Terbilang -->
          <div class="mb-6">
            <p class="text-sm">
              <span class="font-semibold">Terbilang:</span>
              <span id="prevNotaTerbilang" class="italic"></span>
            </p>
          </div>

          <!-- TTD -->
          <div class="grid grid-cols-2 gap-8 mt-16">
            <div class="text-center">
              <p class="mb-16">Penerima,</p>
              <p class="border-t border-black inline-block px-8">
                (.....................)
              </p>
            </div>
            <div class="text-center">
              <p class="mb-16">Hormat Kami,</p>
              <p class="border-t border-black inline-block px-8">
                (.....................)
              </p>
            </div>
          </div>

          <!-- Footer -->
          <div class="text-center text-xs text-gray-500 mt-8 pt-4 border-t">
            <p>Terima kasih atas kepercayaan Anda</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Buat Nota -->
    <div
      id="addNotaModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
      style="display: none"
    >
      <div
        class="bg-white p-6 rounded-lg w-[600px] max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Buat Nota</h3>
          <button
            onclick="closeModal('addNotaModal')"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="addNotaForm">
          <!-- Pilih SO -->
          <div class="mb-4">
            <label class="block text-gray-700 mb-2">Sales Order</label>
            <select
              id="notaSOSelect"
              class="w-full px-3 py-2 border rounded-lg"
              required
              onchange="loadSODetailsForNota()"
            >
              <option value="">Pilih SO</option>
            </select>
          </div>

          <!-- Detail SO -->
          <div id="soDetailsContainer" class="mb-4 hidden">
            <div class="bg-gray-50 p-4 rounded">
              <p class="text-sm mb-2">
                <strong>No SO:</strong> <span id="soDetailNo"></span>
              </p>
              <p class="text-sm mb-2">
                <strong>Pelanggan:</strong> <span id="soDetailPelanggan"></span>
              </p>
              <p class="text-sm mb-2">
                <strong>Total Harga:</strong>
                <span
                  id="soDetailTotal"
                  class="font-bold text-lg text-blue-600"
                ></span>
              </p>

              <hr class="my-3" />

              <h4 class="font-bold mb-2">Detail Barang:</h4>
              <div id="soDetailItems" class="space-y-2"></div>
            </div>
          </div>

          <!-- DP / Uang Muka -->
          <div class="mb-4">
            <label class="block text-gray-700 mb-2"
              >DP / Uang Muka (Opsional)</label
            >
            <input
              type="number"
              id="notaDP"
              class="w-full px-3 py-2 border rounded-lg"
              min="0"
              value="0"
              placeholder="Masukkan jumlah DP"
            />
            <p class="text-sm text-gray-500 mt-1">
              Kosongkan atau isi 0 jika pembayaran lunas
            </p>
          </div>

          <!-- Summary -->
          <div id="notaSummary" class="mb-4 hidden">
            <div class="bg-blue-50 p-4 rounded border border-blue-200">
              <div class="flex justify-between mb-2">
                <span>Total Bayar:</span>
                <span id="summaryTotal" class="font-bold"></span>
              </div>
              <div class="flex justify-between mb-2">
                <span>DP:</span>
                <span id="summaryDP" class="font-bold text-green-600"></span>
              </div>
              <hr class="my-2" />
              <div class="flex justify-between">
                <span class="font-bold">Sisa Bayar:</span>
                <span id="summarySisa" class="font-bold text-red-600"></span>
              </div>
            </div>
          </div>

          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
            >
              <i class="fas fa-file-invoice mr-2"></i> Buat Nota
            </button>
            <button
              type="button"
              onclick="closeModal('addNotaModal')"
              class="flex-1 bg-gray-300 py-2 rounded hover:bg-gray-400"
            >
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Preview Surat Jalan -->
    <div
      id="previewSuratJalanModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
      style="display: none"
    >
      <div class="bg-white rounded-lg w-[800px] max-h-[90vh] overflow-y-auto">
        <div
          class="sticky top-0 bg-white border-b p-4 flex justify-between items-center"
        >
          <h3 class="text-xl font-bold">Preview Surat Jalan</h3>
          <div class="flex gap-2">
            <button
              onclick="window.print()"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              <i class="fas fa-print mr-2"></i> Print
            </button>
            <button
              onclick="closeModal('previewSuratJalanModal')"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div id="suratJalanPreviewContent" class="p-8">
          <div class="text-center border-b-2 border-black pb-4 mb-6">
            <h1 class="text-3xl font-bold">CV. NAMA PERUSAHAAN</h1>
            <p class="text-sm">Jl. Alamat Perusahaan No. 123, Kota</p>
          </div>

          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold">SURAT JALAN</h2>
          </div>

          <div class="grid grid-cols-2 gap-8 mb-6">
            <div>
              <table class="w-full text-sm">
                <tr>
                  <td class="py-1 font-semibold w-32">No. SJ</td>
                  <td class="py-1">: <span id="prevSJNo"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">Tanggal</td>
                  <td class="py-1">: <span id="prevSJTgl"></span></td>
                </tr>
              </table>
            </div>
            <div>
              <table class="w-full text-sm">
                <tr>
                  <td class="py-1 font-semibold w-32">Kepada</td>
                  <td class="py-1">: <span id="prevSJPelanggan"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">Alamat</td>
                  <td class="py-1">: <span id="prevSJAlamat"></span></td>
                </tr>
              </table>
            </div>
          </div>

          <table class="w-full border-collapse border border-gray-300 mb-6">
            <thead class="bg-gray-100">
              <tr>
                <th class="border border-gray-300 px-4 py-2 text-left">No</th>
                <th class="border border-gray-300 px-4 py-2 text-left">
                  Nama Barang
                </th>
                <th class="border border-gray-300 px-4 py-2 text-center">
                  Jumlah
                </th>
                <th class="border border-gray-300 px-4 py-2 text-center">
                  Keterangan
                </th>
              </tr>
            </thead>
            <tbody id="prevSJItems"></tbody>
          </table>

          <div class="grid grid-cols-2 gap-8 mt-16">
            <div class="text-center">
              <p class="mb-16">Penerima,</p>
              <p class="border-t border-black inline-block px-8">
                (.....................)
              </p>
            </div>
            <div class="text-center">
              <p class="mb-16">Pengirim,</p>
              <p class="border-t border-black inline-block px-8">
                (.....................)
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Preview Kwitansi -->
    <div
      id="previewKwitansiModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
      style="display: none"
    >
      <div class="bg-white rounded-lg w-[800px] max-h-[90vh] overflow-y-auto">
        <div
          class="sticky top-0 bg-white border-b p-4 flex justify-between items-center"
        >
          <h3 class="text-xl font-bold">Preview Kwitansi</h3>
          <div class="flex gap-2">
            <button
              onclick="window.print()"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              <i class="fas fa-print mr-2"></i> Print
            </button>
            <button
              onclick="closeModal('previewKwitansiModal')"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div id="kwitansiPreviewContent" class="p-8">
          <div class="text-center border-b-2 border-black pb-4 mb-6">
            <h1 class="text-3xl font-bold">CV. NAMA PERUSAHAAN</h1>
            <p class="text-sm">Jl. Alamat Perusahaan No. 123, Kota</p>
          </div>

          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold">KWITANSI</h2>
          </div>

          <table class="w-full text-sm mb-6">
            <tr>
              <td class="py-2 w-40">No. Kwitansi</td>
              <td class="py-2">: <span id="prevKwitNo"></span></td>
            </tr>
            <tr>
              <td class="py-2">Tanggal</td>
              <td class="py-2">: <span id="prevKwitTgl"></span></td>
            </tr>
          </table>

          <div class="mb-6">
            <p class="mb-4">Telah terima dari:</p>
            <table class="w-full text-sm">
              <tr>
                <td class="py-2 w-40">Nama</td>
                <td class="py-2">: <span id="prevKwitPelanggan"></span></td>
              </tr>
              <tr>
                <td class="py-2">Alamat</td>
                <td class="py-2">: <span id="prevKwitAlamat"></span></td>
              </tr>
            </table>
          </div>

          <div class="border-2 border-black p-4 mb-6">
            <p class="text-lg">
              Uang sejumlah: <span id="prevKwitJumlah" class="font-bold"></span>
            </p>
            <p class="text-sm italic mt-2">
              Terbilang: <span id="prevKwitTerbilang"></span>
            </p>
          </div>

          <div class="mb-6">
            <p>Untuk pembayaran: <span id="prevKwitKeperluan"></span></p>
            <p>
              Metode Pembayaran:
              <span id="prevKwitMetode" class="font-bold"></span>
            </p>
          </div>

          <div class="text-right mt-16">
            <p class="mb-16">Penerima,</p>
            <p class="border-t border-black inline-block px-8">
              (.....................)
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Preview SO -->
    <div
      id="previewSOModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
      style="display: none"
    >
      <div class="bg-white rounded-lg w-[800px] max-h-[90vh] overflow-y-auto">
        <div
          class="sticky top-0 bg-white border-b p-4 flex justify-between items-center"
        >
          <h3 class="text-xl font-bold">Preview Sales Order</h3>
          <div class="flex gap-2">
            <button
              onclick="window.print()"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              <i class="fas fa-print mr-2"></i> Print
            </button>
            <button
              onclick="closeModal('previewSOModal')"
              class="text-gray-500 hover:text-gray-700"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div id="soPreviewContent" class="p-8">
          <div class="text-center border-b-2 border-black pb-4 mb-6">
            <h1 class="text-3xl font-bold">CV. NAMA PERUSAHAAN</h1>
            <p class="text-sm">Jl. Alamat Perusahaan No. 123, Kota</p>
            <p class="text-sm">
              Telp: (021) 12345678 | Email: info@perusahaan.com
            </p>
          </div>

          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold">SALES ORDER</h2>
          </div>

          <div class="grid grid-cols-2 gap-8 mb-6">
            <div>
              <table class="w-full text-sm">
                <tr>
                  <td class="py-1 font-semibold w-32">No. SO</td>
                  <td class="py-1">: <span id="prevSONo"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">Tanggal</td>
                  <td class="py-1">: <span id="prevSOTgl"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">No. PO</td>
                  <td class="py-1">: <span id="prevSOPO"></span></td>
                </tr>
              </table>
            </div>
            <div>
              <table class="w-full text-sm">
                <tr>
                  <td class="py-1 font-semibold w-32">Kepada Yth</td>
                  <td class="py-1">: <span id="prevSOPelanggan"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">Alamat</td>
                  <td class="py-1">: <span id="prevSOAlamat"></span></td>
                </tr>
                <tr>
                  <td class="py-1 font-semibold">Status</td>
                  <td class="py-1">: <span id="prevSOStatus"></span></td>
                </tr>
              </table>
            </div>
          </div>

          <table class="w-full border-collapse border border-gray-300 mb-6">
            <thead class="bg-gray-100">
              <tr>
                <th class="border border-gray-300 px-4 py-2 text-left">No</th>
                <th class="border border-gray-300 px-4 py-2 text-left">
                  Nama Barang
                </th>
                <th class="border border-gray-300 px-4 py-2 text-center">
                  Qty
                </th>
                <th class="border border-gray-300 px-4 py-2 text-right">
                  Harga Satuan
                </th>
                <th class="border border-gray-300 px-4 py-2 text-right">
                  Subtotal
                </th>
              </tr>
            </thead>
            <tbody id="prevSOItems"></tbody>
            <tfoot>
              <tr class="bg-gray-50 font-bold">
                <td
                  colspan="4"
                  class="border border-gray-300 px-4 py-2 text-right"
                >
                  TOTAL
                </td>
                <td
                  class="border border-gray-300 px-4 py-2 text-right"
                  id="prevSOTotal"
                ></td>
              </tr>
            </tfoot>
          </table>

          <div class="grid grid-cols-2 gap-8 mt-16">
            <div class="text-center">
              <p class="mb-16">Menyetujui,</p>
              <p class="border-t border-black inline-block px-8">
                (.....................)
              </p>
            </div>
            <div class="text-center">
              <p class="mb-16">Hormat Kami,</p>
              <p class="border-t border-black inline-block px-8">
                (.....................)
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:5000/api";
      let token = localStorage.getItem("token");

      // Login
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("loginUsername").value;
          const password = document.getElementById("loginPassword").value;

          try {
            const response = await fetch(`${API_URL}/auth/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            });

            const data = await response.json();

            if (data.success) {
              token = data.data.token;
              localStorage.setItem("token", token);
              localStorage.setItem("adminName", data.data.admin.nama);
              document.getElementById("loginPage").classList.add("hidden");
              document
                .getElementById("dashboardPage")
                .classList.remove("hidden");
              document.getElementById("adminName").textContent =
                data.data.admin.nama;
              loadDashboard();
            } else {
              document.getElementById("loginError").textContent = data.message;
              document.getElementById("loginError").classList.remove("hidden");
            }
          } catch (error) {
            document.getElementById("loginError").textContent =
              "Error connecting to server";
            document.getElementById("loginError").classList.remove("hidden");
          }
        });

      // Logout
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("adminName");
        location.reload();
      }

      // Check if already logged in
      if (token) {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("dashboardPage").classList.remove("hidden");
        document.getElementById("adminName").textContent =
          localStorage.getItem("adminName");
        loadDashboard();
      }

      // Show Page
      function showPage(page) {
        document
          .querySelectorAll(".page-content")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById(page + "Content").classList.remove("hidden");

        if (page === "dashboard") loadDashboard();
        if (page === "pelanggan") loadPelanggan();
        if (page === "barang") loadBarang();
        if (page === "po") loadPO();
        if (page === "so") loadSO();
        if (page === "nota") loadNota();
        if (page === "suratjalan") loadSuratJalan();
        if (page === "kwitansi") loadKwitansi();
        if (page === "laporan") loadLaporan();
      }

      // Load Dashboard
      async function loadDashboard() {
        try {
          const response = await fetch(`${API_URL}/laporan/dashboard`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            document.getElementById("statPenjualanHariIni").textContent =
              new Intl.NumberFormat("id-ID", {
                style: "currency",
                currency: "IDR",
              }).format(data.data.penjualan.hariIni);
            document.getElementById("statTransaksiHariIni").textContent =
              data.data.transaksi.hariIni;
            document.getElementById("statTotalPelanggan").textContent =
              data.data.pelanggan.total;
            document.getElementById("statTotalBarang").textContent =
              data.data.barang.total;
          }
        } catch (error) {
          console.error("Error loading dashboard:", error);
        }
      }

      // Load Pelanggan
      async function loadPelanggan() {
        const search = document.getElementById("searchPelanggan")?.value || "";
        try {
          const response = await fetch(
            `${API_URL}/pelanggan?search=${search}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );
          const data = await response.json();

          const tbody = document.getElementById("pelangganTable");
          tbody.innerHTML = "";

          if (data.success && data.data.pelanggan.length > 0) {
            data.data.pelanggan.forEach((p) => {
              tbody.innerHTML += `
                            <tr class="border-b">
                                <td class="px-6 py-3">${p.noplg}</td>
                                <td class="px-6 py-3">${p.nmplg}</td>
                                <td class="px-6 py-3">${p.alamat}</td>
                                <td class="px-6 py-3">${p.telp}</td>
                                <td class="px-6 py-3">
                                    <button onclick="deletePelanggan('${p._id}')" class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
            });
          }
        } catch (error) {
          console.error("Error loading pelanggan:", error);
        }
      }

      // Load Barang
      async function loadBarang() {
        const search = document.getElementById("searchBarang")?.value || "";
        try {
          const response = await fetch(`${API_URL}/barang?search=${search}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const tbody = document.getElementById("barangTable");
          tbody.innerHTML = "";

          if (data.success && data.data.barang.length > 0) {
            data.data.barang.forEach((b) => {
              tbody.innerHTML += `
                            <tr class="border-b">
                                <td class="px-6 py-3">${b.kdbrg}</td>
                                <td class="px-6 py-3">${b.nmbrg}</td>
                                <td class="px-6 py-3">${b.kategori?.nmkategori || "-"}</td>
                                <td class="px-6 py-3">${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(b.harga)}</td>
                                <td class="px-6 py-3">${b.stok}</td>
                                <td class="px-6 py-3">
                                    <button onclick="deleteBarang('${b._id}')" class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
            });
          }
        } catch (error) {
          console.error("Error loading barang:", error);
        }
      }

      // Load PO
      async function loadPO() {
        try {
          const response = await fetch(`${API_URL}/po`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const tbody = document.getElementById("poTable");
          tbody.innerHTML = "";

          if (data.success && data.data.po.length > 0) {
            data.data.po.forEach((p) => {
              tbody.innerHTML += `
                            <tr class="border-b">
                                <td class="px-6 py-3">${p.nopo}</td>
                                <td class="px-6 py-3">${new Date(p.tglpo).toLocaleDateString("id-ID")}</td>
                                <td class="px-6 py-3">${p.pelanggan?.nmplg || "-"}</td>
                                <td class="px-6 py-3">${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(p.jmlhrg)}</td>
                                <td class="px-6 py-3">
                                    <span class="px-2 py-1 rounded text-sm ${p.status === "pending" ? "bg-yellow-200" : "bg-green-200"}">${p.status}</span>
                                </td>
                                <td class="px-6 py-3">
                                    <button onclick="viewPO('${p._id}')" class="text-blue-500 hover:text-blue-700 mr-2">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
            });
          }
        } catch (error) {
          console.error("Error loading PO:", error);
        }
      }

      // Load SO
      async function loadSO() {
        try {
          const response = await fetch(`${API_URL}/so`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const tbody = document.getElementById("soTable");
          tbody.innerHTML = "";

          if (data.success && data.data.so.length > 0) {
            data.data.so.forEach((s) => {
              tbody.innerHTML += `
                            <tr class="border-b">
                                <td class="px-6 py-3">${s.noso}</td>
                                <td class="px-6 py-3">${new Date(s.tglso).toLocaleDateString("id-ID")}</td>
                                <td class="px-6 py-3">${s.po?.nopo || "-"}</td>
                                <td class="px-6 py-3">${s.po?.pelanggan?.nmplg || "-"}</td>
                                <td class="px-6 py-3">
                                    <span class="px-2 py-1 rounded text-sm ${s.status === "pending" ? "bg-yellow-200" : "bg-green-200"}">${s.status}</span>
                                </td>
                                <td class="px-6 py-3">
                                    <button onclick="viewSO('${s._id}')" class="text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
            });
          }
        } catch (error) {
          console.error("Error loading SO:", error);
        }
      }

      // Load Nota
      async function loadNota() {
        try {
          const response = await fetch(`${API_URL}/nota`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const tbody = document.getElementById("notaTable");
          tbody.innerHTML = "";

          if (data.success && data.data.nota.length > 0) {
            data.data.nota.forEach((n) => {
              const statusBayar =
                n.sisaBayar === 0
                  ? '<span class="px-2 py-1 bg-green-200 text-green-800 rounded text-xs">Lunas</span>'
                  : '<span class="px-2 py-1 bg-yellow-200 text-yellow-800 rounded text-xs">Belum Lunas</span>';

              tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-6 py-3">${n.nonota}</td>
                        <td class="px-6 py-3">${new Date(n.tglnota).toLocaleDateString("id-ID")}</td>
                        <td class="px-6 py-3">${n.so?.po?.pelanggan?.nmplg || "-"}</td>
                        <td class="px-6 py-3">${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(n.totalBayar)}</td>
                        <td class="px-6 py-3">
                            ${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(n.sisaBayar)}
                            ${statusBayar}
                        </td>
                        <td class="px-6 py-3">
<button onclick="previewNota('${n._id}')" class="text-blue-500 hover:text-blue-700 mr-2" title="Preview & Print">
    <i class="fas fa-eye"></i> Preview
</button>
                            ${
                              n.sisaBayar > 0
                                ? `
                                <button onclick="bayarNota('${n._id}')" class="text-green-500 hover:text-green-700" title="Bayar Cicilan">
                                    <i class="fas fa-money-bill"></i> Bayar
                                </button>
                            `
                                : ""
                            }
                        </td>
                    </tr>
                `;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="6" class="px-6 py-3 text-center text-gray-500">Belum ada data</td></tr>';
          }
        } catch (error) {
          console.error("Error loading nota:", error);
        }
      }

      // Fungsi bayar nota (redirect ke kwitansi)
      function bayarNota(notaId) {
        showPage("kwitansi");
        setTimeout(() => {
          showAddKwitansiModal();
          // Auto select nota di dropdown
          document.getElementById("kwitansiNotaSelect").value = notaId;
          loadNotaForKwitansi();
        }, 300);
      }

      // Load Laporan
      async function loadLaporan() {
        // Load Barang Terlaris
        try {
          const response = await fetch(
            `${API_URL}/laporan/barang-terlaris?limit=5`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );
          const data = await response.json();

          const div = document.getElementById("barangTerlarisTable");
          div.innerHTML = "";

          if (data.success && data.data.length > 0) {
            div.innerHTML =
              '<table class="w-full"><thead><tr><th class="text-left">Nama Barang</th><th class="text-left">Terjual</th></tr></thead><tbody>';
            data.data.forEach((b) => {
              div.innerHTML += `
                    <tr class="border-b">
                        <td class="py-2">${b.nmbrg}</td>
                        <td class="py-2">${b.totalQty}</td>
                    </tr>
                `;
            });
            div.innerHTML += "</tbody></table>";
          } else {
            div.innerHTML = '<p class="text-gray-500">Belum ada data</p>';
          }
        } catch (error) {
          console.error("Error loading barang terlaris:", error);
        }

        // Load Pelanggan Royal
        try {
          const response = await fetch(
            `${API_URL}/laporan/pelanggan-royal?limit=5`,
            {
              headers: { Authorization: `Bearer ${token}` },
            },
          );
          const data = await response.json();

          const div = document.getElementById("pelangganRoyalTable");
          div.innerHTML = "";

          if (data.success && data.data.length > 0) {
            div.innerHTML =
              '<table class="w-full"><thead><tr><th class="text-left">Nama</th><th class="text-left">Total Belanja</th></tr></thead><tbody>';
            data.data.forEach((p) => {
              div.innerHTML += `
                    <tr class="border-b">
                        <td class="py-2">${p.nmplg}</td>
                        <td class="py-2">${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(p.totalPembelian)}</td>
                    </tr>
                `;
            });
            div.innerHTML += "</tbody></table>";
          } else {
            div.innerHTML = '<p class="text-gray-500">Belum ada data</p>';
          }
        } catch (error) {
          console.error("Error loading pelanggan royal:", error);
        }
      }

      // Show Modal Functions
      function showAddPelangganModal() {
        const modal = document.getElementById("addPelangganModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex"; // Tambahkan ini
      }

      function showAddBarangModal() {
        loadKategoriSelect();
        const modal = document.getElementById("addBarangModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex"; // Tambahkan ini
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        modal.style.display = "none"; // Tambahkan ini
      }
      function showAddPOModal() {
        alert("Fitur Buat PO - Silahkan develop lebih lanjut");
      }

      function showAddSOModal() {
        alert("Fitur Buat SO - Silahkan develop lebih lanjut");
      }

      // Show Add Nota Modal
      async function showAddNotaModal() {
        await loadProcessedSO();
        const modal = document.getElementById("addNotaModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex";
      }

      // Load SO yang sudah processed (belum punya nota)
      async function loadProcessedSO() {
        try {
          const response = await fetch(`${API_URL}/so`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const select = document.getElementById("notaSOSelect");
          select.innerHTML = '<option value="">Pilih SO</option>';

          if (data.success && data.data.so.length > 0) {
            // Filter SO yang statusnya bukan cancelled
            const validSO = data.data.so.filter(
              (s) => s.status !== "cancelled",
            );

            validSO.forEach((s) => {
              select.innerHTML += `<option value="${s._id}">${s.noso} - ${s.po?.pelanggan?.nmplg || "N/A"}</option>`;
            });
          }
        } catch (error) {
          console.error("Error loading SO:", error);
        }
      }

      // Variable untuk menyimpan total
      let currentSOTotal = 0;

      // Load SO Details untuk Nota
      async function loadSODetailsForNota() {
        const soId = document.getElementById("notaSOSelect").value;

        if (!soId) {
          document.getElementById("soDetailsContainer").classList.add("hidden");
          document.getElementById("notaSummary").classList.add("hidden");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/so/${soId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            // Set detail header
            document.getElementById("soDetailNo").textContent =
              data.data.so.noso;
            document.getElementById("soDetailPelanggan").textContent =
              data.data.so.po?.pelanggan?.nmplg || "N/A";

            // Calculate total
            currentSOTotal = data.data.details.reduce(
              (sum, item) => sum + item.subtotal,
              0,
            );
            document.getElementById("soDetailTotal").textContent =
              new Intl.NumberFormat("id-ID", {
                style: "currency",
                currency: "IDR",
              }).format(currentSOTotal);

            // Set items
            const itemsContainer = document.getElementById("soDetailItems");
            itemsContainer.innerHTML = "";

            data.data.details.forEach((item) => {
              itemsContainer.innerHTML += `
                    <div class="flex justify-between text-sm bg-white p-2 rounded">
                        <span>${item.kdbrg?.nmbrg || "N/A"}</span>
                        <span>${item.qty} x ${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(item.hargajual)}</span>
                        <span class="font-bold">${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(item.subtotal)}</span>
                    </div>
                `;
            });

            document
              .getElementById("soDetailsContainer")
              .classList.remove("hidden");

            // Update summary
            updateNotaSummary();
          }
        } catch (error) {
          console.error("Error loading SO details:", error);
        }
      }

      // Update Nota Summary saat DP berubah
      function updateNotaSummary() {
        const dp = parseInt(document.getElementById("notaDP").value) || 0;

        if (currentSOTotal > 0) {
          const sisaBayar = currentSOTotal - dp;

          document.getElementById("summaryTotal").textContent =
            new Intl.NumberFormat("id-ID", {
              style: "currency",
              currency: "IDR",
            }).format(currentSOTotal);

          document.getElementById("summaryDP").textContent =
            new Intl.NumberFormat("id-ID", {
              style: "currency",
              currency: "IDR",
            }).format(dp);

          document.getElementById("summarySisa").textContent =
            new Intl.NumberFormat("id-ID", {
              style: "currency",
              currency: "IDR",
            }).format(sisaBayar);

          document.getElementById("notaSummary").classList.remove("hidden");
        }
      }

      // Load Kategori untuk Select
      async function loadKategoriSelect() {
        try {
          const response = await fetch(`${API_URL}/barang/kategori`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const select = document.getElementById("kategoriSelect");
          select.innerHTML = '<option value="">Pilih Kategori</option>';

          if (data.success && data.data.length > 0) {
            data.data.forEach((k) => {
              select.innerHTML += `<option value="${k._id}">${k.nmkategori}</option>`;
            });
          }
        } catch (error) {
          console.error("Error loading kategori:", error);
        }
      }

      // Add Pelanggan
      document
        .getElementById("addPelangganForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            nmplg: document.getElementById("nmplg").value,
            alamat: document.getElementById("alamat").value,
            telp: document.getElementById("telp").value,
            email: document.getElementById("email").value,
          };

          try {
            const response = await fetch(`${API_URL}/pelanggan`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (data.success) {
              alert("Pelanggan berhasil ditambahkan!");
              closeModal("addPelangganModal");
              document.getElementById("addPelangganForm").reset();
              loadPelanggan();
            } else {
              alert("Error: " + data.message);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      // Add Barang
      document
        .getElementById("addBarangForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            nmbrg: document.getElementById("nmbrg").value,
            kategori: document.getElementById("kategoriSelect").value,
            harga: parseInt(document.getElementById("harga").value),
            stok: parseInt(document.getElementById("stok").value),
          };

          try {
            const response = await fetch(`${API_URL}/barang`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (data.success) {
              alert("Barang berhasil ditambahkan!");
              closeModal("addBarangModal");
              document.getElementById("addBarangForm").reset();
              loadBarang();
            } else {
              alert("Error: " + data.message);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      // Delete Pelanggan
      async function deletePelanggan(id) {
        if (!confirm("Yakin ingin menghapus pelanggan ini?")) return;

        try {
          const response = await fetch(`${API_URL}/pelanggan/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await response.json();

          if (data.success) {
            alert("Pelanggan berhasil dihapus!");
            loadPelanggan();
          } else {
            alert("Error: " + data.message);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // Delete Barang
      async function deleteBarang(id) {
        if (!confirm("Yakin ingin menghapus barang ini?")) return;

        try {
          const response = await fetch(`${API_URL}/barang/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await response.json();

          if (data.success) {
            alert("Barang berhasil dihapus!");
            loadBarang();
          } else {
            alert("Error: " + data.message);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // View PO Detail
      // View PO Detail dengan Modal
      async function viewPO(id) {
        try {
          const response = await fetch(`${API_URL}/po/${id}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            // Buat modal preview
            const modal = document.createElement("div");
            modal.id = "viewPOModal";
            modal.className =
              "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
            modal.style.display = "flex";

            let itemsHTML = "";
            data.data.details.forEach((d, index) => {
              itemsHTML += `
                    <tr class="border-b">
                        <td class="px-4 py-2 text-center">${index + 1}</td>
                        <td class="px-4 py-2">${d.kdbrg?.nmbrg || "-"}</td>
                        <td class="px-4 py-2 text-center">${d.qtypo}</td>
                        <td class="px-4 py-2 text-right">${formatRupiah(d.hargapo)}</td>
                        <td class="px-4 py-2 text-right">${formatRupiah(d.subtotal)}</td>
                    </tr>
                `;
            });

            modal.innerHTML = `
                <div class="bg-white rounded-lg w-[700px] max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                        <h3 class="text-xl font-bold">Detail Purchase Order</h3>
                        <button onclick="document.getElementById('viewPOModal').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600">No PO</p>
                                <p class="font-bold">${data.data.po.nopo}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Tanggal</p>
                                <p class="font-bold">${new Date(data.data.po.tglpo).toLocaleDateString("id-ID")}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Pelanggan</p>
                                <p class="font-bold">${data.data.po.pelanggan?.nmplg || "-"}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Status</p>
                                <p><span class="px-2 py-1 rounded text-sm ${data.data.po.status === "pending" ? "bg-yellow-200" : "bg-green-200"}">${data.data.po.status}</span></p>
                            </div>
                        </div>
                        
                        <h4 class="font-bold mb-2">Detail Barang:</h4>
                        <table class="w-full border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 px-4 py-2">No</th>
                                    <th class="border border-gray-300 px-4 py-2">Nama Barang</th>
                                    <th class="border border-gray-300 px-4 py-2">Qty</th>
                                    <th class="border border-gray-300 px-4 py-2">Harga</th>
                                    <th class="border border-gray-300 px-4 py-2">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="4" class="border border-gray-300 px-4 py-2 text-right">TOTAL</td>
                                    <td class="border border-gray-300 px-4 py-2 text-right">${formatRupiah(data.data.po.jmlhrg)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }
      // View SO Detail
      async function viewSO(id) {
        try {
          const response = await fetch(`${API_URL}/so/${id}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            alert(
              `Detail SO: ${data.data.so.noso}\nPO: ${data.data.so.po.nopo}\nStatus: ${data.data.so.status}`,
            );
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // Print Nota
      function printNota(id) {
        window.open(`${API_URL}/nota/${id}/print?token=${token}`, "_blank");
      }

      // Download Laporan Penjualan
      function downloadLaporanPenjualan() {
        const startDate = prompt("Masukkan tanggal mulai (YYYY-MM-DD):");
        const endDate = prompt("Masukkan tanggal akhir (YYYY-MM-DD):");

        if (startDate && endDate) {
          window.open(
            `${API_URL}/laporan/penjualan?startDate=${startDate}&endDate=${endDate}`,
            "_blank",
          );
        }
      }

      // Fix modal pada saat load
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("addPelangganModal").style.display = "none";
        document.getElementById("addBarangModal").style.display = "none";
      });

      // Show Kategori Modal
      function showKategoriModal() {
        loadKategoriList();
        const modal = document.getElementById("kategoriModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex";
      }

      // Load Kategori List
      async function loadKategoriList() {
        try {
          const response = await fetch(`${API_URL}/barang/kategori`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const div = document.getElementById("kategoriList");
          div.innerHTML = "";

          if (data.success && data.data.length > 0) {
            data.data.forEach((k) => {
              div.innerHTML += `
                    <div class="flex justify-between items-center p-2 border-b hover:bg-gray-50">
                        <div>
                            <div class="font-semibold">${k.nmkategori}</div>
                            <div class="text-sm text-gray-500">${k.deskripsi || "-"}</div>
                        </div>
                        <button onclick="deleteKategori('${k._id}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
          } else {
            div.innerHTML =
              '<p class="text-gray-500 text-sm">Belum ada kategori</p>';
          }
        } catch (error) {
          console.error("Error loading kategori:", error);
        }
      }

      // Add Kategori
      document
        .getElementById("addKategoriForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = {
            nmkategori: document.getElementById("nmkategori").value,
            deskripsi: document.getElementById("deskripsi").value,
          };

          try {
            const response = await fetch(`${API_URL}/barang/kategori`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (data.success) {
              alert("Kategori berhasil ditambahkan!");
              document.getElementById("addKategoriForm").reset();
              loadKategoriList(); // Reload list
            } else {
              alert("Error: " + data.message);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      // Delete Kategori
      async function deleteKategori(id) {
        if (!confirm("Yakin ingin menghapus kategori ini?")) return;

        try {
          const response = await fetch(`${API_URL}/barang/kategori/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });

          const data = await response.json();

          if (data.success) {
            alert("Kategori berhasil dihapus!");
            loadKategoriList();
          } else {
            alert("Error: " + data.message);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // Global variable untuk menyimpan data barang
      let allBarangData = [];

      // Show Add PO Modal
      async function showAddPOModal() {
        await loadPelangganSelect();
        await loadAllBarang();
        const modal = document.getElementById("addPOModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex";
      }

      // Load Pelanggan untuk Select
      async function loadPelangganSelect() {
        try {
          const response = await fetch(`${API_URL}/pelanggan?limit=1000`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const select = document.getElementById("poPelangganSelect");
          select.innerHTML = '<option value="">Pilih Pelanggan</option>';

          if (data.success && data.data.pelanggan.length > 0) {
            data.data.pelanggan.forEach((p) => {
              select.innerHTML += `<option value="${p._id}">${p.nmplg}</option>`;
            });
          }
        } catch (error) {
          console.error("Error loading pelanggan:", error);
        }
      }

      // Load All Barang
      async function loadAllBarang() {
        try {
          const response = await fetch(`${API_URL}/barang?limit=1000`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            allBarangData = data.data.barang;
            updateAllBarangSelects();
          }
        } catch (error) {
          console.error("Error loading barang:", error);
        }
      }

      // Update All Barang Selects
      function updateAllBarangSelects() {
        const selects = document.querySelectorAll(".po-barang-select");
        selects.forEach((select) => {
          select.innerHTML = '<option value="">Pilih Barang</option>';
          allBarangData.forEach((b) => {
            select.innerHTML += `<option value="${b._id}" data-harga="${b.harga}">${b.nmbrg} - Rp ${b.harga.toLocaleString("id-ID")}</option>`;
          });
        });
      }

      // Add PO Item
      function addPOItem() {
        const container = document.getElementById("poItemsContainer");
        const newItem = document.createElement("div");
        newItem.className = "po-item flex gap-2 mb-2";
        newItem.innerHTML = `
        <select class="flex-1 px-3 py-2 border rounded-lg po-barang-select" required>
            <option value="">Pilih Barang</option>
        </select>
        <input type="number" placeholder="Qty" class="w-24 px-3 py-2 border rounded-lg po-qty" min="1" required>
        <button type="button" onclick="removePOItem(this)" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">
            <i class="fas fa-trash"></i>
        </button>
    `;
        container.appendChild(newItem);
        updateAllBarangSelects();
      }

      // Remove PO Item
      function removePOItem(button) {
        const items = document.querySelectorAll(".po-item");
        if (items.length > 1) {
          button.parentElement.remove();
        } else {
          alert("Minimal harus ada 1 barang!");
        }
      }

      // Submit PO Form
      document
        .getElementById("addPOForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const pelanggan = document.getElementById("poPelangganSelect").value;
          const items = [];

          document.querySelectorAll(".po-item").forEach((item) => {
            const barangId = item.querySelector(".po-barang-select").value;
            const qty = parseInt(item.querySelector(".po-qty").value);

            if (barangId && qty > 0) {
              items.push({
                kdbrg: barangId,
                qtypo: qty,
              });
            }
          });

          if (items.length === 0) {
            alert("Pilih minimal 1 barang!");
            return;
          }

          try {
            const response = await fetch(`${API_URL}/po`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ pelanggan, items }),
            });

            const data = await response.json();

            if (data.success) {
              alert("PO berhasil dibuat!");
              closeModal("addPOModal");
              document.getElementById("addPOForm").reset();
              loadPO();
            } else {
              alert("Error: " + data.message);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      // Show Add SO Modal
      async function showAddSOModal() {
        await loadPendingPO();
        const modal = document.getElementById("addSOModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex";
      }

      // Load Pending PO
      async function loadPendingPO() {
        try {
          const response = await fetch(`${API_URL}/po?status=pending`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const select = document.getElementById("soPOSelect");
          select.innerHTML = '<option value="">Pilih PO</option>';

          if (data.success && data.data.po.length > 0) {
            data.data.po.forEach((p) => {
              select.innerHTML += `<option value="${p._id}">${p.nopo} - ${p.pelanggan.nmplg}</option>`;
            });
          }
        } catch (error) {
          console.error("Error loading PO:", error);
        }
      }

      // Load PO Details
      async function loadPODetails() {
        const poId = document.getElementById("soPOSelect").value;

        if (!poId) {
          document.getElementById("poDetailsContainer").classList.add("hidden");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/po/${poId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            document.getElementById("poDetailPelanggan").textContent =
              data.data.po.pelanggan.nmplg;
            document.getElementById("poDetailTotal").textContent =
              new Intl.NumberFormat("id-ID", {
                style: "currency",
                currency: "IDR",
              }).format(data.data.po.jmlhrg);
            document
              .getElementById("poDetailsContainer")
              .classList.remove("hidden");

            // Load items
            const container = document.getElementById("soItemsContainer");
            container.innerHTML = "";

            data.data.details.forEach((detail) => {
              container.innerHTML += `
                    <div class="flex gap-2 mb-2 items-center">
                        <input type="hidden" class="so-barang-id" value="${detail.kdbrg._id}">
                        <div class="flex-1 px-3 py-2 border rounded-lg bg-gray-50">${detail.kdbrg.nmbrg}</div>
                        <input type="number" placeholder="Qty" class="w-24 px-3 py-2 border rounded-lg so-qty" min="1" max="${detail.qtypo}" value="${detail.qtypo}" required>
                        <span class="text-sm text-gray-500">Max: ${detail.qtypo}</span>
                    </div>
                `;
            });
          }
        } catch (error) {
          console.error("Error loading PO details:", error);
        }
      }

      // Submit SO Form
      document
        .getElementById("addSOForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const poId = document.getElementById("soPOSelect").value;
          const items = [];

          document
            .querySelectorAll("#soItemsContainer > div")
            .forEach((item) => {
              const barangId = item.querySelector(".so-barang-id").value;
              const qty = parseInt(item.querySelector(".so-qty").value);

              if (barangId && qty > 0) {
                items.push({
                  kdbrg: barangId,
                  qty: qty,
                });
              }
            });

          if (items.length === 0) {
            alert("Pilih minimal 1 barang!");
            return;
          }

          try {
            const response = await fetch(`${API_URL}/so`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ po: poId, items }),
            });

            const data = await response.json();

            if (data.success) {
              alert("SO berhasil dibuat! Stok barang sudah dikurangi.");
              closeModal("addSOModal");
              document.getElementById("addSOForm").reset();
              loadSO();
              loadPO(); // Refresh PO juga karena statusnya berubah
            } else {
              alert("Error: " + data.message);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      // ============= SURAT JALAN =============

      // Show Add Surat Jalan Modal
      async function showAddSuratJalanModal() {
        await loadSOForSuratJalan();
        const modal = document.getElementById("addSuratJalanModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex";
      }

      // Load SO untuk Surat Jalan
      async function loadSOForSuratJalan() {
        try {
          const response = await fetch(`${API_URL}/so`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const select = document.getElementById("sjSOSelect");
          select.innerHTML = '<option value="">Pilih SO</option>';

          if (data.success && data.data.so.length > 0) {
            data.data.so.forEach((s) => {
              select.innerHTML += `<option value="${s._id}">${s.noso} - ${s.po?.pelanggan?.nmplg || "N/A"}</option>`;
            });
          }
        } catch (error) {
          console.error("Error loading SO:", error);
        }
      }

      // Load SO Detail untuk SJ
      async function loadSOForSJ() {
        const soId = document.getElementById("sjSOSelect").value;

        if (!soId) {
          document.getElementById("sjSODetail").classList.add("hidden");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/so/${soId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            document.getElementById("sjPelanggan").textContent =
              data.data.so.po?.pelanggan?.nmplg || "N/A";
            document.getElementById("sjAlamatDefault").textContent =
              data.data.so.po?.pelanggan?.alamat || "N/A";
            document.getElementById("sjAlamat").value =
              data.data.so.po?.pelanggan?.alamat || "";
            document.getElementById("sjSODetail").classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading SO:", error);
        }
      }

      // Submit Surat Jalan Form
      document
        .getElementById("addSuratJalanForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const soId = document.getElementById("sjSOSelect").value;
          const alamatkirim = document.getElementById("sjAlamat").value;

          try {
            const response = await fetch(`${API_URL}/surat-jalan`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ so: soId, alamatkirim }),
            });

            const data = await response.json();

            if (data.success) {
              alert("Surat Jalan berhasil dibuat!");
              closeModal("addSuratJalanModal");
              document.getElementById("addSuratJalanForm").reset();
              loadSuratJalan();
            } else {
              alert("Error: " + data.message);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      // Load Surat Jalan
      async function loadSuratJalan() {
        try {
          const response = await fetch(`${API_URL}/surat-jalan`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const tbody = document.getElementById("suratJalanTable");
          tbody.innerHTML = "";

          if (data.success && data.data.suratJalan.length > 0) {
            data.data.suratJalan.forEach((sj) => {
              tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="px-6 py-3">${sj.nosj}</td>
                        <td class="px-6 py-3">${new Date(sj.tglsj).toLocaleDateString("id-ID")}</td>
                        <td class="px-6 py-3">${sj.so?.noso || "-"}</td>
                        <td class="px-6 py-3">${sj.so?.po?.pelanggan?.nmplg || "-"}</td>
                        <td class="px-6 py-3">${sj.alamatkirim}</td>
                        <td class="px-6 py-3">
                            <button onclick="printSuratJalan('${sj._id}')" class="text-blue-500 hover:text-blue-700">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </td>
                    </tr>
                `;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="6" class="px-6 py-3 text-center text-gray-500">Belum ada data</td></tr>';
          }
        } catch (error) {
          console.error("Error loading surat jalan:", error);
        }
      }

      // Print Surat Jalan
      function printSuratJalan(id) {
        window.open(
          `${API_URL}/surat-jalan/${id}/print?token=${token}`,
          "_blank",
        );
      }

      // ============= KWITANSI =============

      // Show Add Kwitansi Modal
      async function showAddKwitansiModal() {
        await loadNotaWithSisa();
        const modal = document.getElementById("addKwitansiModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex";
      }

      // Load Nota yang masih ada sisa bayar
      async function loadNotaWithSisa() {
        try {
          const response = await fetch(`${API_URL}/nota`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const select = document.getElementById("kwitansiNotaSelect");
          select.innerHTML = '<option value="">Pilih Nota</option>';

          if (data.success && data.data.nota.length > 0) {
            // Filter nota yang masih punya sisa bayar
            const notaWithSisa = data.data.nota.filter((n) => n.sisaBayar > 0);

            notaWithSisa.forEach((n) => {
              select.innerHTML += `<option value="${n._id}">${n.nonota} - ${n.so?.po?.pelanggan?.nmplg || "N/A"} (Sisa: ${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(n.sisaBayar)})</option>`;
            });
          }
        } catch (error) {
          console.error("Error loading nota:", error);
        }
      }

      // Variable untuk menyimpan sisa bayar
      let currentSisaBayar = 0;

      // Load Nota Detail untuk Kwitansi
      async function loadNotaForKwitansi() {
        const notaId = document.getElementById("kwitansiNotaSelect").value;

        if (!notaId) {
          document.getElementById("kwitansiNotaDetail").classList.add("hidden");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/nota/${notaId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            currentSisaBayar = data.data.nota.sisaBayar;

            document.getElementById("kwitansiPelanggan").textContent =
              data.data.nota.so?.po?.pelanggan?.nmplg || "N/A";
            document.getElementById("kwitansiTotal").textContent =
              new Intl.NumberFormat("id-ID", {
                style: "currency",
                currency: "IDR",
              }).format(data.data.nota.totalBayar);
            document.getElementById("kwitansiDP").textContent =
              new Intl.NumberFormat("id-ID", {
                style: "currency",
                currency: "IDR",
              }).format(data.data.nota.dp);
            document.getElementById("kwitansiSisa").textContent =
              new Intl.NumberFormat("id-ID", {
                style: "currency",
                currency: "IDR",
              }).format(data.data.nota.sisaBayar);

            // Set max jumlah bayar
            document.getElementById("kwitansiJumlah").max = currentSisaBayar;
            document.getElementById("kwitansiJumlah").placeholder =
              `Max: ${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(currentSisaBayar)}`;

            document
              .getElementById("kwitansiNotaDetail")
              .classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading nota:", error);
        }
      }

      // Submit Kwitansi Form
      document
        .getElementById("addKwitansiForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const notaId = document.getElementById("kwitansiNotaSelect").value;
          const jumlahBayar = parseInt(
            document.getElementById("kwitansiJumlah").value,
          );
          const metodeBayar = document.getElementById("kwitansiMetode").value;

          if (jumlahBayar > currentSisaBayar) {
            alert("Jumlah bayar tidak boleh melebihi sisa bayar!");
            return;
          }

          try {
            const response = await fetch(`${API_URL}/kwitansi`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                nota: notaId,
                jumlahBayar,
                metodeBayar,
              }),
            });

            const data = await response.json();

            if (data.success) {
              alert("Kwitansi berhasil dibuat!");
              closeModal("addKwitansiModal");
              document.getElementById("addKwitansiForm").reset();
              loadKwitansi();
              loadNota(); // Refresh nota juga
            } else {
              alert("Error: " + data.message);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      // Load Kwitansi
      async function loadKwitansi() {
        try {
          const response = await fetch(`${API_URL}/kwitansi`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          const tbody = document.getElementById("kwitansiTable");
          tbody.innerHTML = "";

          if (data.success && data.data.kwitansi.length > 0) {
            data.data.kwitansi.forEach((k) => {
              tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="px-6 py-3">${k.nokwit}</td>
                        <td class="px-6 py-3">${new Date(k.tglkwit).toLocaleDateString("id-ID")}</td>
                        <td class="px-6 py-3">${k.nota?.nonota || "-"}</td>
                        <td class="px-6 py-3">${k.nota?.so?.po?.pelanggan?.nmplg || "-"}</td>
                        <td class="px-6 py-3">${new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(k.jumlahBayar)}</td>
                        <td class="px-6 py-3">
                            <span class="px-2 py-1 rounded text-sm bg-green-200">${k.metodeBayar}</span>
                        </td>
                        <td class="px-6 py-3">
                            <button onclick="printKwitansi('${k._id}')" class="text-blue-500 hover:text-blue-700">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </td>
                    </tr>
                `;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="7" class="px-6 py-3 text-center text-gray-500">Belum ada data</td></tr>';
          }
        } catch (error) {
          console.error("Error loading kwitansi:", error);
        }
      }

      // Print Kwitansi
      function printKwitansi(id) {
        window.open(`${API_URL}/kwitansi/${id}/print?token=${token}`, "_blank");
      }

      // Variable untuk menyimpan data nota yang sedang di-preview
      let currentNotaData = null;

      // Fungsi untuk preview nota
      async function previewNota(notaId) {
        try {
          const response = await fetch(`${API_URL}/nota/${notaId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            currentNotaData = data.data;

            // Set data ke preview
            document.getElementById("prevNotaNo").textContent =
              data.data.nota.nonota;
            document.getElementById("prevNotaTgl").textContent = new Date(
              data.data.nota.tglnota,
            ).toLocaleDateString("id-ID", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            document.getElementById("prevNotaSO").textContent =
              data.data.nota.so?.noso || "-";
            document.getElementById("prevNotaPelanggan").textContent =
              data.data.nota.so?.po?.pelanggan?.nmplg || "-";
            document.getElementById("prevNotaAlamat").textContent =
              data.data.nota.so?.po?.pelanggan?.alamat || "-";
            document.getElementById("prevNotaTelp").textContent =
              data.data.nota.so?.po?.pelanggan?.telp || "-";

            // Set items
            const itemsBody = document.getElementById("prevNotaItems");
            itemsBody.innerHTML = "";

            data.data.details.forEach((item, index) => {
              itemsBody.innerHTML += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2 text-center">${index + 1}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.kdbrg?.nmbrg || "-"}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${item.qty}</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">${formatRupiah(item.hargajual)}</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">${formatRupiah(item.subtotal)}</td>
                    </tr>
                `;
            });

            // Set totals
            document.getElementById("prevNotaTotal").textContent = formatRupiah(
              data.data.nota.totalBayar,
            );
            document.getElementById("prevNotaDP").textContent = formatRupiah(
              data.data.nota.dp,
            );
            document.getElementById("prevNotaSisa").textContent = formatRupiah(
              data.data.nota.sisaBayar,
            );

            // Set terbilang
            document.getElementById("prevNotaTerbilang").textContent =
              terbilang(data.data.nota.totalBayar) + " Rupiah";

            // Show modal
            const modal = document.getElementById("previewNotaModal");
            modal.classList.remove("hidden");
            modal.classList.add("flex");
            modal.style.display = "flex";
          }
        } catch (error) {
          alert("Error loading nota: " + error.message);
        }
      }

      // Format Rupiah
      function formatRupiah(angka) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(angka);
      }

      // Fungsi Terbilang
      function terbilang(angka) {
        const bilangan = [
          "",
          "Satu",
          "Dua",
          "Tiga",
          "Empat",
          "Lima",
          "Enam",
          "Tujuh",
          "Delapan",
          "Sembilan",
          "Sepuluh",
          "Sebelas",
        ];

        if (angka < 12) {
          return bilangan[angka];
        } else if (angka < 20) {
          return terbilang(angka - 10) + " Belas";
        } else if (angka < 100) {
          return (
            terbilang(Math.floor(angka / 10)) +
            " Puluh " +
            terbilang(angka % 10)
          );
        } else if (angka < 200) {
          return "Seratus " + terbilang(angka - 100);
        } else if (angka < 1000) {
          return (
            terbilang(Math.floor(angka / 100)) +
            " Ratus " +
            terbilang(angka % 100)
          );
        } else if (angka < 2000) {
          return "Seribu " + terbilang(angka - 1000);
        } else if (angka < 1000000) {
          return (
            terbilang(Math.floor(angka / 1000)) +
            " Ribu " +
            terbilang(angka % 1000)
          );
        } else if (angka < 1000000000) {
          return (
            terbilang(Math.floor(angka / 1000000)) +
            " Juta " +
            terbilang(angka % 1000000)
          );
        } else if (angka < 1000000000000) {
          return (
            terbilang(Math.floor(angka / 1000000000)) +
            " Milyar " +
            terbilang(angka % 1000000000)
          );
        } else {
          return (
            terbilang(Math.floor(angka / 1000000000000)) +
            " Triliun " +
            terbilang(angka % 1000000000000)
          );
        }
      }

      // Download PDF dari preview
      function downloadNotaPDF() {
        if (currentNotaData) {
          const encodedToken = encodeURIComponent(token);
          window.open(
            `${API_URL}/nota/${currentNotaData.nota._id}/print?token=${encodedToken}`,
            "_blank",
          );
        }
      }

      // Update fungsi printNota jadi preview
      function printNota(id) {
        previewNota(id);
      }

      // Update Nota Summary saat DP berubah
      document
        .getElementById("notaDP")
        .addEventListener("input", updateNotaSummary);

      // Submit Nota Form
      document
        .getElementById("addNotaForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const soId = document.getElementById("notaSOSelect").value;
          const dp = parseInt(document.getElementById("notaDP").value) || 0;

          if (!soId) {
            alert("Pilih SO terlebih dahulu!");
            return;
          }

          if (dp > currentSOTotal) {
            alert("DP tidak boleh melebihi total harga!");
            return;
          }

          try {
            const response = await fetch(`${API_URL}/nota`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                so: soId,
                dp: dp,
              }),
            });

            const data = await response.json();

            if (data.success) {
              alert(
                "Nota berhasil dibuat!\n\n" +
                  "No Nota: " +
                  data.data.nota.nonota +
                  "\n" +
                  "Total: " +
                  new Intl.NumberFormat("id-ID", {
                    style: "currency",
                    currency: "IDR",
                  }).format(data.data.nota.totalBayar) +
                  "\n" +
                  "DP: " +
                  new Intl.NumberFormat("id-ID", {
                    style: "currency",
                    currency: "IDR",
                  }).format(data.data.nota.dp) +
                  "\n" +
                  "Sisa Bayar: " +
                  new Intl.NumberFormat("id-ID", {
                    style: "currency",
                    currency: "IDR",
                  }).format(data.data.nota.sisaBayar),
              );

              closeModal("addNotaModal");
              document.getElementById("addNotaForm").reset();
              document
                .getElementById("soDetailsContainer")
                .classList.add("hidden");
              document.getElementById("notaSummary").classList.add("hidden");
              currentSOTotal = 0;
              loadNota();
            } else {
              alert("Error: " + data.message);
            }
          } catch (error) {
            alert("Error: " + error.message);
          }
        });

      // Preview Surat Jalan
      async function previewSuratJalan(sjId) {
        try {
          const response = await fetch(`${API_URL}/surat-jalan/${sjId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            document.getElementById("prevSJNo").textContent =
              data.data.suratJalan.nosj;
            document.getElementById("prevSJTgl").textContent = new Date(
              data.data.suratJalan.tglsj,
            ).toLocaleDateString("id-ID");
            document.getElementById("prevSJPelanggan").textContent =
              data.data.suratJalan.so?.po?.pelanggan?.nmplg || "-";
            document.getElementById("prevSJAlamat").textContent =
              data.data.suratJalan.alamatkirim;

            const itemsBody = document.getElementById("prevSJItems");
            itemsBody.innerHTML = "";

            data.data.details.forEach((item, index) => {
              itemsBody.innerHTML += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2 text-center">${index + 1}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.kdbrg?.nmbrg || "-"}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${item.qty}</td>
                        <td class="border border-gray-300 px-4 py-2"></td>
                    </tr>
                `;
            });

            const modal = document.getElementById("previewSuratJalanModal");
            modal.classList.remove("hidden");
            modal.classList.add("flex");
            modal.style.display = "flex";
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // Preview Kwitansi
      async function previewKwitansi(kwitId) {
        try {
          const response = await fetch(`${API_URL}/kwitansi/${kwitId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            document.getElementById("prevKwitNo").textContent =
              data.data.nokwit;
            document.getElementById("prevKwitTgl").textContent = new Date(
              data.data.tglkwit,
            ).toLocaleDateString("id-ID");
            document.getElementById("prevKwitPelanggan").textContent =
              data.data.nota?.so?.po?.pelanggan?.nmplg || "-";
            document.getElementById("prevKwitAlamat").textContent =
              data.data.nota?.so?.po?.pelanggan?.alamat || "-";
            document.getElementById("prevKwitJumlah").textContent =
              formatRupiah(data.data.jumlahBayar);
            document.getElementById("prevKwitTerbilang").textContent =
              terbilang(data.data.jumlahBayar) + " Rupiah";
            document.getElementById("prevKwitKeperluan").textContent =
              "Nota " + (data.data.nota?.nonota || "-");
            document.getElementById("prevKwitMetode").textContent =
              data.data.metodeBayar.toUpperCase();

            const modal = document.getElementById("previewKwitansiModal");
            modal.classList.remove("hidden");
            modal.classList.add("flex");
            modal.style.display = "flex";
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // Update fungsi print
      function printSuratJalan(id) {
        previewSuratJalan(id);
      }

      function printKwitansi(id) {
        previewKwitansi(id);
      }

      // Preview SO
      async function previewSO(soId) {
        try {
          const response = await fetch(`${API_URL}/so/${soId}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            document.getElementById("prevSONo").textContent = data.data.so.noso;
            document.getElementById("prevSOTgl").textContent = new Date(
              data.data.so.tglso,
            ).toLocaleDateString("id-ID", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            document.getElementById("prevSOPO").textContent =
              data.data.so.po?.nopo || "-";
            document.getElementById("prevSOPelanggan").textContent =
              data.data.so.po?.pelanggan?.nmplg || "-";
            document.getElementById("prevSOAlamat").textContent =
              data.data.so.po?.pelanggan?.alamat || "-";
            document.getElementById("prevSOStatus").textContent =
              data.data.so.status.toUpperCase();

            const itemsBody = document.getElementById("prevSOItems");
            itemsBody.innerHTML = "";

            let total = 0;
            data.data.details.forEach((item, index) => {
              total += item.subtotal;
              itemsBody.innerHTML += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2 text-center">${index + 1}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.kdbrg?.nmbrg || "-"}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${item.qty}</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">${formatRupiah(item.hargajual)}</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">${formatRupiah(item.subtotal)}</td>
                    </tr>
                `;
            });

            document.getElementById("prevSOTotal").textContent =
              formatRupiah(total);

            const modal = document.getElementById("previewSOModal");
            modal.classList.remove("hidden");
            modal.classList.add("flex");
            modal.style.display = "flex";
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // Update fungsi viewSO
      function viewSO(id) {
        previewSO(id);
      }
    </script>
  </body>
</html>
